<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>3</storyId>
    <title>Structured Logging</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/5-3-structured-logging.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>DevOps observability engineer</asA>
    <iWant>JSON-structured logs with context fields</iWant>
    <soThat>logs integrate cleanly with ELK/Splunk/Loki and are machine-parsable</soThat>
    <tasks>- Add `MOONFRP_LOG_FORMAT` config with default `text` (AC: 1)
- Implement `log_json` and route via `log` (AC: 1,2)
  - Include fields: timestamp, level, message, application, version (AC: 2,3)
  - Support optional fields via parameters/env (AC: 5)
- Ensure performance threshold (&lt;1ms/entry) (AC: 4)
  - Micro-bench and optimize string building
- Ensure error logs include stack/trace context when available (AC: 6)
- Tests (AC: 1â€“6)
  - `test_json_logging_format`
  - `test_json_logging_valid`
  - `test_json_logging_performance`
  - `test_text_logging_default`</tasks>
  </story>

  <acceptanceCriteria>1. `--log-format=json` outputs structured JSON logs
2. Each log entry includes: timestamp, level, message, context
3. Compatible with common log parsers
4. Performance: &lt;1ms overhead per log entry
5. Optional fields: service, operation, duration
6. Errors include stack traces when available</acceptanceCriteria>

  <artifacts>
    <docs></docs>
    <code></code>
    <dependencies></dependencies>
  </artifacts>

  <constraints>Keep default `text` logging unchanged; JSON is opt-in; avoid external deps; pure shell-compatible implementation.</constraints>
  <interfaces></interfaces>
  <tests>
    <standards></standards>
    <locations></locations>
    <ideas></ideas>
  </tests>
</story-context>

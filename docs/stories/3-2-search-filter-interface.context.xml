<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>2</storyId>
    <title>Search &amp; Filter Interface</title>
    <status>drafted</status>
    <generatedAt>2025-11-02T22:05:00.000Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-2-search-filter-interface.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>DevOps engineer managing 50+ tunnels</asA>
    <iWant>to instantly search and filter configurations by name, IP, port, tag, or status</iWant>
    <soThat>I can quickly find specific tunnels without manually browsing through 50 configs</soThat>
    <tasks>
      - Implement core search functions (AC: 1, 2)
        - Create search_configs() function in new moonfrp-search.sh module
        - Support search types: auto, name, ip, port, tag, status
        - Use SQLite index queries for fast results (&lt;50ms)
        - Return results as pipe-separated values for easy parsing
      - Implement auto-detect search (AC: 1)
        - Create search_configs_auto() function
        - Detect IP pattern: `^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$`
        - Detect port pattern: `^[0-9]+$` with range 1-65535
        - Detect tag pattern: contains `:`
        - Default to name search if no pattern matches
      - Implement name search with fuzzy matching (AC: 1, 6)
        - Create name search query: `SELECT ... WHERE file_path LIKE '%query%'`
        - Support partial name matching (LIKE operator)
        - Case-insensitive matching (use LOWER() or case-insensitive grep)
      - Implement IP search (AC: 1)
        - Query: `SELECT ... WHERE server_addr='query' OR bind_port='query'`
        - Return matching configs with server or bind port match
      - Implement port search (AC: 1)
        - Query: `SELECT ... WHERE server_port=query OR bind_port=query`
        - Handle numeric port matching
      - Integrate tag search (AC: 1)
        - Use query_configs_by_tag() from Story 2.3
        - Fallback if Story 2.3 not available
      - Create interactive search menu (AC: 3)
        - Create search_filter_menu() function
        - Options: Quick Search, Search by Name, Search by IP, Search by Port, Search by Tag, Filter by Status, Advanced Filter Builder, Saved Filters
        - Integrate into main menu as option 5
      - Implement quick search interactive (AC: 1, 2)
        - Create quick_search_interactive() function
        - Prompt for query (auto-detect type)
        - Display results with config details
        - Show operations menu on results
      - Implement search by name interactive (AC: 1, 6)
        - Create search_by_name_interactive() function
        - Prompt for name query
        - Display fuzzy matching results
      - Implement search by IP interactive (AC: 1)
        - Create search_by_ip_interactive() function
        - Prompt for IP address
        - Display matching configs
      - Implement search by port interactive (AC: 1)
        - Create search_by_port_interactive() function
        - Prompt for port number
        - Display matching configs
      - Implement search by tag interactive (AC: 1)
        - Create search_by_tag_interactive() function
        - Prompt for tag (key:value format)
        - Use Story 2.3 tagging system
      - Implement filter by status interactive (AC: 1)
        - Create filter_by_status_interactive() function
        - Filter by service status: active, failed, inactive
        - Query systemctl for service status
        - Match against configs in index
      - Implement advanced filter builder (AC: 3)
        - Create advanced_filter_builder() function
        - Support multiple filter criteria combination
        - Add/remove filters interactively
        - Apply filters to show results
        - Save filter preset option
      - Implement filter preset saving (AC: 4)
        - Create save_filter_preset() function
        - Store presets in $HOME/.moonfrp/filter_presets.json
        - Use jq for JSON manipulation (if available)
        - Support preset naming
      - Implement filter preset loading (AC: 4)
        - Create load_filter_preset() function
        - Load preset from JSON file
        - Create saved_filters_menu() to list and apply presets
      - Implement operations on search results (AC: 5)
        - Add operations menu to search results display
        - Support: View config, Edit config, Restart service(s), View service status
        - Apply operations to all search results
        - Integrate with Story 2.1 bulk operations for restart
      - Performance testing (AC: 2)
        - Create test_search_by_name_under_50ms() test
        - Create test_search_by_ip() test
        - Create test_search_by_port() test
        - Verify all searches complete in &lt;50ms
      - Functional testing (AC: 1, 3, 4, 5, 6)
        - Create test_search_by_tag() test
        - Create test_fuzzy_name_matching() test
        - Create test_operations_on_search_results() test
        - Create test_save_load_filter_presets() test
        - Test auto-detect search pattern recognition
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Search configs by: name, server IP, port, tag, status
    2. Results in &lt;50ms from index
    3. Interactive filter builder
    4. Save common filters as presets
    5. Operations on search results (bulk restart filtered services)
    6. Fuzzy matching for name search
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics/epic-03-performance-ux.md" title="Epic 3: Performance &amp; UX at Scale" section="Story 3.2: Search &amp; Filter Interface">
        Provides complete problem statement, acceptance criteria, detailed technical specification with implementation patterns, search function implementations, auto-detect logic, interactive menu patterns, filter preset patterns, and performance requirements. Includes complete code examples for search_configs(), search_configs_auto(), search_filter_menu(), quick_search_interactive(), advanced_filter_builder(), and preset management functions.
      </doc>
      <doc path="docs/stories/3-2-search-filter-interface.md" title="Story 3.2: Search &amp; Filter Interface">
        Complete story definition with requirements context, implementation patterns, dependencies, integration points, search implementation details, filter preset patterns, and testing strategy. Specifies new module pattern, search functions, and menu integration requirements.
      </doc>
      <doc path="docs/epics/epic-01-scale-foundation.md" title="Epic 1: Critical Fixes &amp; Scale Foundation" section="Story 1.2: Implement Config Index">
        Establishes SQLite index foundation used by this story for fast search queries. Documents database schema, query patterns, and performance characteristics required for &lt;50ms search results.
      </doc>
    </docs>
    <code>
      <file path="moonfrp-index.sh" kind="index-module" symbol="query_configs_by_tag" lines="667-722" reason="Tag search function from Story 2.3 - used by search_configs() when search_type is 'tag'. Returns config file paths matching tag query (key:value or key-only)">
        Tag search function that queries config_index table joined with service_tags table. Supports exact match (key:value) and key-only match. Returns newline-separated file paths. Used by search_configs() for tag search type.
      </file>
      <file path="moonfrp-index.sh" kind="index-module" symbol="query_configs_by_type" lines="287-319" reason="Demonstrates SQLite query pattern with pipe-separated output - pattern to use for search_configs() return format">
        Shows SQLite query pattern with -separator '|' flag for pipe-separated output. Pattern: sqlite3 -separator '|' "$db_path" "SELECT ...". Used as template for search_configs() return format.
      </file>
      <file path="moonfrp-index.sh" kind="index-module" symbol="INDEX_DB_PATH" reason="Database path constant used by all search functions - defines location of SQLite index database">
        Index database path: $HOME/.moonfrp/index.db. Used by all search functions to query config metadata. Defined as INDEX_DB_PATH constant in moonfrp-index.sh.
      </file>
      <file path="moonfrp-services.sh" kind="service-module" symbol="bulk_restart_services" lines="527-531" reason="Bulk restart function from Story 2.1 - used for restarting filtered services from search results">
        Bulk restart function that takes service list and max_parallel parameter. Calls bulk_service_operation() with "restart" operation. Used by search results operations menu for restarting multiple filtered services.
      </file>
      <file path="moonfrp-services.sh" kind="service-module" symbol="get_moonfrp_services" lines="358-363" reason="Function demonstrates pattern for getting service names from configs - pattern needed for converting search results to service names">
        Shows pattern for converting config files to service names: moonfrp-$(basename "$config_file" .toml). Used in search results operations menu to get service names for restart operations.
      </file>
      <file path="moonfrp-ui.sh" kind="ui-module" symbol="show_header" lines="19-32" reason="Header display function used by interactive menus - needed for search_filter_menu() and search result displays">
        Header display function with title and subtitle parameters. Used by all interactive menus including search_filter_menu() and search result displays. Provides consistent UI formatting.
      </file>
      <file path="moonfrp-ui.sh" kind="ui-module" symbol="safe_read" reason="Safe input reading function used throughout UI - needed for all interactive search prompts">
        Safe input reading function with prompt, variable name, and default value parameters. Used by all interactive search functions for user input. Provides consistent input handling.
      </file>
      <file path="moonfrp-ui.sh" kind="ui-module" symbol="main_menu" lines="294-363" reason="Main menu function where search_filter_menu() will be integrated as option 5">
        Main menu function that needs integration of search_filter_menu() as option 5. Current menu options need to be updated to include search functionality.
      </file>
      <file path="moonfrp-core.sh" kind="core-utility" symbol="log" reason="Logging function used throughout codebase for error/info/warn messages - used in search functions">
        Standard logging function for all modules. Used in search functions for error handling and debug messages.
      </file>
    </code>
    <dependencies>
      <ecosystem name="bash">
        <package name="bash">Bash shell scripting (system dependency)</package>
        <package name="sqlite3">SQLite3 command-line tool for fast index queries (required for all search types)</package>
        <package name="jq">JSON parser for filter preset manipulation (optional, fallback available if not present)</package>
        <package name="grep">Grep command for pattern matching in auto-detect search (coreutils)</package>
        <package name="systemctl">Systemd service manager for status-based filtering (required for status filter)</package>
      </ecosystem>
      <ecosystem name="database">
        <package name="SQLite3">Embedded SQL database engine for config index queries (from Story 1.2)</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="file-location">New module file moonfrp-search.sh must be created - following modular architecture pattern</constraint>
    <constraint type="performance">Search results: &lt;50ms from index queries (vs file parsing which would be much slower)</constraint>
    <constraint type="dependency">Requires Story 1.2 config index (SQLite database) for fast queries - uses query patterns from index module</constraint>
    <constraint type="dependency">Requires Story 2.3 tagging system (query_configs_by_tag() function) for tag search - fallback gracefully if not available</constraint>
    <constraint type="dependency">Requires Story 2.1 bulk operations (bulk_restart_services() function) for restarting filtered services - use for operations on search results</constraint>
    <constraint type="integration">Must source moonfrp-search.sh in main moonfrp.sh script - following module loading pattern</constraint>
    <constraint type="integration">Must add search_filter_menu() to main menu as option 5 - integrate with existing menu system</constraint>
    <constraint type="preset-storage">Filter presets stored in $HOME/.moonfrp/filter_presets.json - directory must be writable</constraint>
    <constraint type="preset-format">Filter presets JSON format: [{"name": "preset_name", "filters": {...}}] - use jq if available, fallback if not</constraint>
    <constraint type="search-return-format">Search results must return pipe-separated values: file_path|config_type|server_addr|proxy_count - consistent with existing query patterns</constraint>
    <constraint type="auto-detect-patterns">Auto-detect must check IP pattern first (^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$), then port (^[0-9]+$ range 1-65535), then tag (contains :), default to name</constraint>
  </constraints>

  <interfaces>
    <interface name="search_configs" kind="bash-function" signature="search_configs(query, search_type) - Core search function with type support, returns pipe-separated results" path="moonfrp-search.sh">
      Core search function accepting query string and search_type (auto|name|ip|port|tag|status). Returns pipe-separated values: file_path|config_type|server_addr|proxy_count. Uses SQLite index for fast queries. Performance target: &lt;50ms.
    </interface>
    <interface name="search_configs_auto" kind="bash-function" signature="search_configs_auto(query) - Auto-detect search type from query pattern" path="moonfrp-search.sh">
      Auto-detect function that analyzes query string to determine search type. Checks IP pattern, port pattern, tag pattern (contains :), defaults to name search. Calls search_configs() with detected type.
    </interface>
    <interface name="search_filter_menu" kind="bash-function" signature="search_filter_menu() - Interactive search menu" path="moonfrp-search.sh">
      Interactive menu providing search options: Quick Search, Search by Name, Search by IP, Search by Port, Search by Tag, Filter by Status, Advanced Filter Builder, Saved Filters. Integrates into main menu as option 5.
    </interface>
    <interface name="quick_search_interactive" kind="bash-function" signature="quick_search_interactive() - Quick search interface with auto-detect" path="moonfrp-search.sh">
      Quick search interface that prompts for query, auto-detects type, displays results with config details, and shows operations menu. Uses search_configs() with "auto" type.
    </interface>
    <interface name="advanced_filter_builder" kind="bash-function" signature="advanced_filter_builder() - Multi-criteria filter builder" path="moonfrp-search.sh">
      Advanced filter builder allowing multiple filter criteria combination. Supports add/remove filters, apply filters to show results, save as preset. Uses associative array for filter storage.
    </interface>
    <interface name="save_filter_preset" kind="bash-function" signature="save_filter_preset(preset_name, filters) - Save filter preset to JSON file" path="moonfrp-search.sh">
      Saves filter preset to $HOME/.moonfrp/filter_presets.json. Uses jq for JSON manipulation if available, fallback if not. Preset format: {"name": "preset_name", "filters": {...}}.
    </interface>
    <interface name="load_filter_preset" kind="bash-function" signature="load_filter_preset(preset_name) - Load filter preset from JSON file" path="moonfrp-search.sh">
      Loads filter preset from JSON file. Uses jq for parsing if available, fallback if not. Returns filter criteria for use in advanced_filter_builder().
    </interface>
    <interface name="query_configs_by_tag" kind="bash-function" signature="query_configs_by_tag(tag_query) - Query configs by tag from Story 2.3" path="moonfrp-index.sh">
      Tag search function from Story 2.3. Accepts tag query (key:value or key-only), returns newline-separated config file paths. Used by search_configs() when search_type is 'tag'. Must check availability before calling.
    </interface>
    <interface name="sqlite3 name search query" kind="database-query" signature="SELECT file_path, config_type, server_addr, proxy_count FROM config_index WHERE file_path LIKE '%query%'" path="moonfrp-index.sh via sqlite3">
      SQL query pattern for name search with fuzzy matching. Uses LIKE operator with wildcards for partial matching. Execute via: sqlite3 -separator '|' "$db_path" "SELECT ... WHERE file_path LIKE '%query%'".
    </interface>
    <interface name="sqlite3 IP search query" kind="database-query" signature="SELECT ... WHERE server_addr='query' OR bind_port='query'" path="moonfrp-index.sh via sqlite3">
      SQL query pattern for IP search. Matches server_addr exactly or bind_port exactly. Execute via: sqlite3 -separator '|' "$db_path" "SELECT ... WHERE server_addr='query' OR bind_port='query'".
    </interface>
    <interface name="sqlite3 port search query" kind="database-query" signature="SELECT ... WHERE server_port=query OR bind_port=query" path="moonfrp-index.sh via sqlite3">
      SQL query pattern for port search. Matches server_port or bind_port numerically. Execute via: sqlite3 -separator '|' "$db_path" "SELECT ... WHERE server_port=query OR bind_port=query".
    </interface>
    <interface name="bulk_restart_services" kind="bash-function" signature="bulk_restart_services(max_parallel) - Restart multiple services in parallel from Story 2.1" path="moonfrp-services.sh">
      Bulk restart function from Story 2.1. Takes max_parallel parameter (default 10), gets all MoonFRP services, restarts in parallel. Used by search results operations menu for restarting filtered services.
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing follows bash unit testing patterns established in previous stories. Performance testing is critical - must verify &lt;50ms search query time for all search types. Functional tests must verify each search type, auto-detect pattern recognition, fuzzy name matching, filter preset save/load, and operations on search results. Tests should follow pattern from tests/test_config_index.sh and tests/test_tagging_system.sh with performance test helpers using date +%s%N timing.
    </standards>
    <locations>
      Test file location: tests/test_search_filter_interface.sh (create following pattern from tests/test_config_index.sh and tests/test_tagging_system.sh)
    </locations>
    <ideas>
      <test ac="2">test_search_by_name_under_50ms - Performance test: name search must complete in &lt;50ms with 50 configs. Use LIKE query with file_path pattern.</test>
      <test ac="1">test_search_by_ip - Functional test: verify IP search returns configs matching server_addr or bind_port exactly.</test>
      <test ac="1">test_search_by_port - Functional test: verify port search returns configs matching server_port or bind_port numerically.</test>
      <test ac="1">test_search_by_tag - Functional test: verify tag search uses query_configs_by_tag() correctly, handles key:value and key-only queries.</test>
      <test ac="6">test_fuzzy_name_matching - Functional test: verify name search supports partial matching (LIKE '%query%'), case-insensitive matching.</test>
      <test ac="1">test_auto_detect_ip_pattern - Functional test: verify auto-detect correctly identifies IP pattern (^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$) and routes to IP search.</test>
      <test ac="1">test_auto_detect_port_pattern - Functional test: verify auto-detect correctly identifies port pattern (^[0-9]+$ range 1-65535) and routes to port search.</test>
      <test ac="1">test_auto_detect_tag_pattern - Functional test: verify auto-detect correctly identifies tag pattern (contains :) and routes to tag search.</test>
      <test ac="1">test_auto_detect_defaults_to_name - Functional test: verify auto-detect defaults to name search if no pattern matches.</test>
      <test ac="3">test_advanced_filter_builder - Functional test: verify advanced filter builder allows adding/removing multiple filter criteria, applies filters correctly.</test>
      <test ac="4">test_save_filter_preset - Functional test: verify save_filter_preset() saves preset to JSON file with correct format, handles jq availability gracefully.</test>
      <test ac="4">test_load_filter_preset - Functional test: verify load_filter_preset() loads preset from JSON file, handles jq availability gracefully.</test>
      <test ac="5">test_operations_on_search_results - Functional test: verify operations menu on search results works for view config, edit config, restart service(s), view service status.</test>
      <test ac="5">test_bulk_restart_filtered_services - Functional test: verify restart operation on search results uses bulk_restart_services() correctly for multiple filtered services.</test>
      <test ac="1">test_filter_by_status - Functional test: verify filter_by_status_interactive() queries systemctl for service status and matches against configs correctly.</test>
      <test ac="2">test_all_search_types_under_50ms - Performance test: verify all search types (name, IP, port, tag) complete in &lt;50ms with 50 configs.</test>
    </ideas>
  </tests>
</story-context>

